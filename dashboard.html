<script>

const SUPABASE_URL = "https://goabrqjuguybmvjlqylq.supabase.co";
const SUPABASE_KEY = "YOUR_ANON_KEY_HERE";

async function loadDashboard() {

  const tbody = document.getElementById("positions");

  try {

    // 1. Fetch your open trades
    const tradesRes = await fetch(
      `${SUPABASE_URL}/rest/v1/trades?status=eq.OPEN`,
      {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`
        }
      }
    );

    const trades = await tradesRes.json();

    // 2. Fetch live OSRS prices
    const priceRes = await fetch(
      "https://prices.runescape.wiki/api/v1/osrs/latest"
    );

    const priceData = await priceRes.json();

    if (!Array.isArray(trades) || trades.length === 0) {

      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="padding:8px;color:#888;">
            No open positions
          </td>
        </tr>
      `;

      return;
    }

    // 3. Build table rows with decision logic
    tbody.innerHTML = trades.map(trade => {

      const market = priceData.data[trade.item_id];

      if (!market) return "";

      const current =
        Math.floor((market.high + market.low) / 2);

      const buy =
        trade.buy_price;

      const profit =
        current - buy;

      const stopPrice =
        Math.floor(buy * 0.92);

      let signal = "HOLD";
      let signalColor = "orange";

      if (current <= stopPrice) {
        signal = "SELL";
        signalColor = "red";
      }

      const profitColor =
        profit >= 0 ? "limegreen" : "red";

      return `
        <tr style="border-bottom:1px solid #222;">

          <td style="padding:8px;">
            ${trade.item_name}
          </td>

          <td style="padding:8px;text-align:right;">
            ${buy.toLocaleString()}
          </td>

          <td style="padding:8px;text-align:right;">
            ${current.toLocaleString()}
          </td>

          <td style="padding:8px;text-align:right;color:${profitColor};">
            ${profit.toLocaleString()}
          </td>

          <td style="padding:8px;text-align:right;">
            Stop: ${stopPrice.toLocaleString()}<br>
            <span style="color:${signalColor};font-weight:bold;">
              ${signal}
            </span>
          </td>

        </tr>
      `;

    }).join("");

  }
  catch (err) {

    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="padding:8px;color:red;">
          Error loading dashboard
        </td>
      </tr>
    `;

  }

}

// Run immediately
loadDashboard();

</script>
