<!DOCTYPE html>
<html>

<head>
  <title>OSRS Trading Dashboard</title>
  <meta charset="UTF-8">
  <style>
    .log-trade-panel input,
    .log-trade-panel select {
      box-sizing: border-box;
      border-radius: 6px;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .log-trade-panel input:focus,
    .log-trade-panel select:focus {
      outline: none;
      border-color: #6a9e5c;
      box-shadow: 0 0 0 2px rgba(106, 158, 92, 0.25);
    }
    .log-trade-panel button {
      border-radius: 6px;
      transition: background 0.15s, transform 0.05s;
    }
    .log-trade-panel button:hover {
      background: #85c977 !important;
    }
    .log-trade-panel button:active {
      transform: scale(0.98);
    }
    .log-trade-panel .log-field-label {
      display: block;
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
    }
  </style>
</head>

<body style="font-family:Arial;background:#111;color:#eee;padding:20px;">

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
  <h1 style="margin:0;">OSRS Trading Dashboard</h1>
  <span id="lastUpdatedStamp" style="font-size:11px;color:#666;">—</span>
</div>


<!-- OPEN TRADES -->

<section style="margin-bottom:32px;">
  <h2 style="margin-bottom:12px;font-size:1.25rem;">Open trades</h2>
  <table style="border-collapse:collapse;width:100%;max-width:720px;">
    <thead>
      <tr style="border-bottom:2px solid #444;">
        <th style="padding:10px 12px;text-align:left;">Item</th>
        <th style="padding:10px 12px;text-align:left;">Date</th>
        <th style="padding:10px 12px;text-align:right;">Buy Price</th>
        <th style="padding:10px 12px;text-align:right;">Current Price</th>
        <th style="padding:10px 12px;text-align:right;">Profit / Loss</th>
        <th style="padding:10px 12px;text-align:right;">Signal</th>
        <th style="padding:10px 12px;text-align:center;">Close trade</th>
      </tr>
    </thead>
    <tbody id="openTradesBody">
      <tr>
        <td colspan="7" style="padding:12px;color:#888;">Loading…</td>
      </tr>
    </tbody>
  </table>
</section>

<!-- CLOSED TRADES -->

<section style="margin-bottom:32px;">
  <h2 style="margin-bottom:12px;font-size:1.25rem;">Closed trades</h2>
  <table style="border-collapse:collapse;width:100%;max-width:720px;">
    <thead>
      <tr style="border-bottom:2px solid #444;">
        <th style="padding:10px 12px;text-align:left;">Item</th>
        <th style="padding:10px 12px;text-align:left;">Date</th>
        <th style="padding:10px 12px;text-align:right;">Buy Price</th>
        <th style="padding:10px 12px;text-align:right;">Sell Price</th>
        <th style="padding:10px 12px;text-align:right;">Profit / Loss</th>
      </tr>
    </thead>
    <tbody id="closedTradesBody">
      <tr>
        <td colspan="5" style="padding:12px;color:#888;">Loading…</td>
      </tr>
    </tbody>
  </table>
</section>

<!-- STABLE OPPORTUNITIES (stable volume + stable spread, with instabuy/instasell) -->

<section style="margin-bottom:32px;">
  <h2 style="margin-bottom:12px;font-size:1.25rem;">Stable opportunities</h2>
  <p style="color:#888;font-size:13px;margin-bottom:12px;">Items with stable volume and stable spread (last 12h). Instabuy = price to buy now; Instasell = price you get selling now.</p>
  <div style="margin-bottom:12px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
    <label style="display:flex;align-items:center;gap:6px;"><span style="color:#888;">Min volume (12h)</span><input type="number" id="stableOppMinVolume" value="100000" min="0" style="width:100px;padding:6px;background:#222;color:#eee;border:1px solid #444;border-radius:4px;"></label>
    <label style="display:flex;align-items:center;gap:6px;"><span style="color:#888;">Max vol CV</span><input type="number" id="stableOppMaxVolCV" value="0.35" min="0" step="0.05" style="width:70px;padding:6px;background:#222;color:#eee;border:1px solid #444;border-radius:4px;"></label>
    <label style="display:flex;align-items:center;gap:6px;"><span style="color:#888;">Max spread CV</span><input type="number" id="stableOppMaxSpreadCV" value="0.3" min="0" step="0.05" style="width:70px;padding:6px;background:#222;color:#eee;border:1px solid #444;border-radius:4px;"></label>
    <button type="button" onclick="loadStableOpportunities()" style="padding:8px 14px;background:#333;color:#eee;border:1px solid #555;border-radius:6px;cursor:pointer;">Scan</button>
  </div>
  <table style="border-collapse:collapse;width:100%;max-width:900px;">
    <thead>
      <tr style="border-bottom:2px solid #444;">
        <th style="padding:10px 12px;text-align:left;">Item</th>
        <th style="padding:10px 12px;text-align:right;">Instabuy</th>
        <th style="padding:10px 12px;text-align:right;">Instasell</th>
        <th style="padding:10px 12px;text-align:right;">Margin</th>
        <th style="padding:10px 12px;text-align:right;">Vol CV</th>
        <th style="padding:10px 12px;text-align:right;">Spread CV</th>
      </tr>
    </thead>
    <tbody id="stableOpportunitiesBody">
      <tr><td colspan="6" style="padding:12px;color:#888;">Run Scan to load.</td></tr>
    </tbody>
  </table>
</section>

<!-- CLOSE TRADE MODAL -->

<div id="closeTradeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center;">
  <div style="background:#1a1a1a;border:1px solid #444;border-radius:8px;padding:24px;min-width:280px;">
    <h3 style="margin:0 0 16px 0;">Close this trade</h3>
    <p style="margin:0 0 8px 0;color:#aaa;">Item: <strong id="closeTradeItemName" style="color:#eee;"></strong></p>
    <p style="margin:0 0 16px 0;color:#aaa;">Buy price: <strong id="closeTradeBuyPrice" style="color:#eee;"></strong> GP</p>
    <label style="display:block;margin-bottom:6px;color:#aaa;font-size:14px;">Sell price (GP)</label>
    <input id="closeTradeSellPrice" type="number" min="0" placeholder="e.g. 1017240" style="width:100%;padding:8px;margin-bottom:16px;background:#222;color:#eee;border:1px solid #444;border-radius:4px;box-sizing:border-box;">
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button type="button" onclick="cancelCloseTrade()" style="padding:8px 16px;background:#333;color:#eee;border:1px solid #555;border-radius:4px;cursor:pointer;">Cancel</button>
      <button type="button" onclick="confirmCloseTrade()" style="padding:8px 16px;background:limegreen;color:#000;border:none;border-radius:4px;font-weight:bold;cursor:pointer;">Confirm</button>
    </div>
  </div>
</div>



<!-- LOG TRADE PANEL -->

<div class="log-trade-panel" style="
  position: fixed;
  top: 20px;
  right: 20px;
  background: #1a1a1a;
  padding: 20px 22px;
  border: 1px solid #333;
  border-radius: 10px;
  width: 260px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
">

  <h3 style="margin: 0 0 18px 0; font-size: 1.1rem; font-weight: 600; color: #eee;">Log Trade</h3>

  <label class="log-field-label" for="log_trade_type">Type</label>
  <select id="log_trade_type" style="width:100%;margin-bottom:14px;padding:10px 10px;background:#222;color:#eee;border:1px solid #444;font-size:14px;">
    <option value="buy">Buy</option>
    <option value="sell">Sell</option>
  </select>

  <label class="log-field-label" for="log_item_id">Item ID</label>
  <input id="log_item_id" placeholder="e.g. 21902" style="width:100%;margin-bottom:14px;padding:10px 10px;background:#222;color:#eee;border:1px solid #444;font-size:14px;">

  <label class="log-field-label" for="log_item_name">Item name</label>
  <input id="log_item_name" placeholder="e.g. Dragon crossbow" style="width:100%;margin-bottom:14px;padding:10px 10px;background:#222;color:#eee;border:1px solid #444;font-size:14px;">

  <label class="log-field-label" for="log_price">Price (GP)</label>
  <input id="log_price" type="number" min="0" placeholder="e.g. 741000" style="width:100%;margin-bottom:14px;padding:10px 10px;background:#222;color:#eee;border:1px solid #444;font-size:14px;">

  <label class="log-field-label" for="log_quantity">Quantity</label>
  <input id="log_quantity" type="number" min="1" value="1" style="width:100%;margin-bottom:18px;padding:10px 10px;background:#222;color:#eee;border:1px solid #444;font-size:14px;">

  <button onclick="logTrade()" style="
    width: 100%;
    padding: 12px 16px;
    background: limegreen;
    color: #0d0d0d;
    border: none;
    font-weight: 700;
    font-size: 14px;
    letter-spacing: 0.03em;
    cursor: pointer;
  ">Log trade</button>

  <div id="log_status" style="margin-top:12px;font-size:12px;min-height:16px;color:#888;"></div>

</div>



<script>

const SUPABASE_URL =
"https://goabrqjuguybmvjlqylq.supabase.co";

const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvYWJycWp1Z3V5Ym12amxxeWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjMxOTgsImV4cCI6MjA4NjgzOTE5OH0.INEv8kOskPZO6fU6827a9XZkkl8Smzqht5_KVDzQ_Ro";



/* LOG TRADE FUNCTION */

async function logTrade() {

  const item_id =
  parseInt(
    document.getElementById("log_item_id").value
  );

  const item_name =
  document.getElementById("log_item_name").value.trim();

  const tradeType =
  document.getElementById("log_trade_type").value;

  const price =
  parseInt(
    document.getElementById("log_price").value
  );

  const quantity =
  parseInt(
    document.getElementById("log_quantity").value
  ) || 1;

  const statusEl =
  document.getElementById("log_status");


  if (!item_id || !item_name || !price) {

    statusEl.innerText =
    "Missing fields";

    statusEl.style.color =
    "red";

    return;

  }


  statusEl.innerText =
  "Logging...";

  statusEl.style.color =
  "orange";


  try {

    const res =
    await fetch(
      `${SUPABASE_URL}/rest/v1/trades`,
      {
        method: "POST",

        headers: {

          apikey:
          SUPABASE_KEY,

          Authorization:
          `Bearer ${SUPABASE_KEY}`,

          "Content-Type":
          "application/json",

          Prefer:
          "return=minimal"

        },

        body:
        JSON.stringify({

          item_id:
          item_id,

          item_name:
          item_name,

          buy_price:
          price,

          quantity:
          quantity,

          status:
          tradeType === "buy" ? "OPEN" : "CLOSED"

        })

      }
    );


    if (res.ok) {

      statusEl.innerText =
      "Logged ✓";

      statusEl.style.color =
      "limegreen";


      document.getElementById("log_item_id").value = "";
      document.getElementById("log_item_name").value = "";
      document.getElementById("log_price").value = "";
      document.getElementById("log_quantity").value = "1";


      loadDashboard();

    }

    else {

      const errText =
      await res.text();

      statusEl.innerText =
      "Error " + res.status + ": " + (errText.slice(0, 80) || "check Supabase");

      statusEl.style.color =
      "red";

    }

  }

  catch (err) {

    statusEl.innerText =
    "Error: " + (err && err.message ? err.message : "network?");

    statusEl.style.color =
    "red";

  }

}





function formatTradeDate(isoString) {
  if (!isoString) return "—";
  const d = new Date(isoString);
  if (isNaN(d.getTime())) return "—";
  const day = d.getDate();
  const ord = day === 1 || day === 21 || day === 31 ? "st" : day === 2 || day === 22 ? "nd" : day === 3 || day === 23 ? "rd" : "th";
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return day + ord + " " + months[d.getMonth()];
}

/* LOAD OPEN POSITIONS */

async function loadDashboard() {

  const openTbody =
  document.getElementById("openTradesBody");

  const closedTbody =
  document.getElementById("closedTradesBody");

  try {

    const tradesRes =
    await fetch(
      `${SUPABASE_URL}/rest/v1/trades`,
      {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization:
          `Bearer ${SUPABASE_KEY}`
        }
      }
    );

    const allTrades =
    await tradesRes.json();


    const priceRes =
    await fetch(
      "https://prices.runescape.wiki/api/v1/osrs/latest"
    );

    const priceData =
    await priceRes.json();


    updateLastUpdatedStamp();


    const openTrades =
    allTrades
    .filter(t => t.status === "OPEN")
    .sort((a, b) => (b.id || 0) - (a.id || 0));

    const closedTrades =
    allTrades
    .filter(t => t.status === "CLOSED" || (t.status !== "OPEN" && t.sell_price != null))
    .sort((a, b) => (b.id || 0) - (a.id || 0));


    if (openTrades.length === 0) {

      openTbody.innerHTML =
      `<tr><td colspan="7" style="padding:12px;color:#888;">No open trades</td></tr>`;

    } else {

      openTbody.innerHTML =
      openTrades.map(trade => {

        const market =
        priceData.data[trade.item_id];

        if (!market) return "";

        const current =
        Math.floor(
          (market.high + market.low) / 2
        );

        const buy =
        trade.buy_price;

        const profit =
        current - buy;

        const stopPrice =
        Math.floor(buy * 0.92);

        let signal =
        "HOLD";

        let signalColor =
        "orange";

        if (current <= stopPrice) {

          signal =
          "SELL";

          signalColor =
          "red";

        }

        const profitColor =
        profit >= 0 ? "limegreen" : "red";

        const itemNameEsc =
        (trade.item_name || "").replace(/"/g, "&quot;");

        return `<tr style="border-bottom:1px solid #333;">
            <td style="padding:10px 12px;">${trade.item_name}</td>
            <td style="padding:10px 12px;">${formatTradeDate(trade.buy_time)}</td>
            <td style="padding:10px 12px;text-align:right;">${buy.toLocaleString()}</td>
            <td style="padding:10px 12px;text-align:right;">${current.toLocaleString()}</td>
            <td style="padding:10px 12px;text-align:right;color:${profitColor};">${profit.toLocaleString()}</td>
            <td style="padding:10px 12px;text-align:right;">Stop: ${stopPrice.toLocaleString()}<br><span style="color:${signalColor};font-weight:bold;">${signal}</span></td>
            <td style="padding:10px 12px;text-align:center;">
              <button onclick="openCloseTradeModal(this)" data-id="${trade.id}" data-item-name="${itemNameEsc}" data-buy-price="${buy}" style="padding:6px 12px;font-size:12px;cursor:pointer;background:#333;color:#eee;border:1px solid #555;border-radius:4px;">Close trade</button>
            </td>
          </tr>`;

      }).join("");

    }


    if (closedTrades.length === 0) {

      closedTbody.innerHTML =
      `<tr><td colspan="5" style="padding:12px;color:#888;">No closed trades</td></tr>`;

    } else {

      closedTbody.innerHTML =
      closedTrades.map(trade => {

        const buy =
        trade.buy_price;

        const sell =
        trade.sell_price;

        const profit =
        sell != null ? sell - buy : null;

        const profitColor =
        profit != null && profit >= 0 ? "limegreen" : profit != null ? "red" : "inherit";

        const profitStr =
        profit != null ? profit.toLocaleString() : "—";

        return `
          <tr style="border-bottom:1px solid #333;">
            <td style="padding:10px 12px;">${trade.item_name}</td>
            <td style="padding:10px 12px;">${formatTradeDate(trade.buy_time)}</td>
            <td style="padding:10px 12px;text-align:right;">${buy.toLocaleString()}</td>
            <td style="padding:10px 12px;text-align:right;">${sell != null ? sell.toLocaleString() : "—"}</td>
            <td style="padding:10px 12px;text-align:right;color:${profitColor};">${profitStr}</td>
          </tr>
        `;

      }).join("");

    }

  }

  catch {

    openTbody.innerHTML =
    `<tr><td colspan="7" style="padding:12px;color:red;">Error loading trades</td></tr>`;

    closedTbody.innerHTML =
    `<tr><td colspan="5" style="padding:12px;color:red;">Error loading trades</td></tr>`;

  }

}


function updateLastUpdatedStamp() {

  const el =
  document.getElementById("lastUpdatedStamp");

  if (el)
  el.textContent =
  "Updated " + new Date().toLocaleString();

}


let closingTradeId = null;

function openCloseTradeModal(btn) {

  const id =
  btn.getAttribute("data-id");

  const itemName =
  btn.getAttribute("data-item-name") || "";

  const buyPrice =
  btn.getAttribute("data-buy-price");

  closingTradeId = id;

  document.getElementById("closeTradeItemName").textContent = itemName;

  document.getElementById("closeTradeBuyPrice").textContent = buyPrice != null && buyPrice !== "" ? Number(buyPrice).toLocaleString() : "—";

  document.getElementById("closeTradeSellPrice").value = "";

  document.getElementById("closeTradeModal").style.display = "flex";

}

function cancelCloseTrade() {

  closingTradeId = null;

  document.getElementById("closeTradeModal").style.display = "none";

}

async function confirmCloseTrade() {

  if (closingTradeId == null)
  return;

  const sellPriceStr =
  document.getElementById("closeTradeSellPrice").value.trim();

  if (sellPriceStr === "") {

    alert("Enter sell price (GP).");

    return;

  }

  const sellPrice =
  parseInt(sellPriceStr, 10);

  if (isNaN(sellPrice) || sellPrice < 0) {

    alert("Enter a valid price.");

    return;

  }

  try {

    const res =
    await fetch(
      `${SUPABASE_URL}/rest/v1/trades?id=eq.${encodeURIComponent(closingTradeId)}`,
      {
        method: "PATCH",

        headers: {

          apikey: SUPABASE_KEY,

          Authorization:
          `Bearer ${SUPABASE_KEY}`,

          "Content-Type":
          "application/json"

        },

        body:
        JSON.stringify({

          sell_price: sellPrice,

          status: "CLOSED"

        })

      }
    );

    cancelCloseTrade();

    if (res.ok)
    loadDashboard();
    else {

      const errText =
      await res.text();

      alert("Error " + res.status + ": " + (errText.slice(0, 100) || "check Supabase"));

    }

  }
  catch (err) {

    alert("Error: " + (err && err.message ? err.message : "network?"));

  }

}




const WIKI_HEADERS = {
  "User-Agent": "OSRS-Price-Tracker/1.0 (https://github.com/jesse594/price-tracker)",
  "Accept": "application/json"
};

function stdDev(arr) {
  if (arr.length === 0) return 0;
  const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
  const sq = arr.map(x => (x - mean) ** 2).reduce((a, b) => a + b, 0);
  return Math.sqrt(sq / arr.length);
}

async function loadStableOpportunities() {
  const tbody = document.getElementById("stableOpportunitiesBody");
  const minVol = Number(document.getElementById("stableOppMinVolume").value) || 100000;
  const maxVolCV = Number(document.getElementById("stableOppMaxVolCV").value) || 0.35;
  const maxSpreadCV = Number(document.getElementById("stableOppMaxSpreadCV").value) || 0.3;

  tbody.innerHTML = "<tr><td colspan=\"6\" style=\"padding:12px;color:#888;\">Loading 12h + latest…</td></tr>";

  try {
    const nowSec = Math.floor(Date.now() / 1000);
    const startOfCurrentHour = Math.floor(nowSec / 3600) * 3600;
    const timestamps = [];
    for (let i = 0; i < 12; i++) timestamps.push(startOfCurrentHour - i * 3600);

    const [mappingRes, latestRes, ...hourResponses] = await Promise.all([
      fetch("https://prices.runescape.wiki/api/v1/osrs/mapping", { headers: WIKI_HEADERS }),
      fetch("https://prices.runescape.wiki/api/v1/osrs/latest", { headers: WIKI_HEADERS }),
      ...timestamps.map(ts => fetch("https://prices.runescape.wiki/api/v1/osrs/1h?timestamp=" + ts, { headers: WIKI_HEADERS }))
    ]);

    const mapping = await mappingRes.json();
    const latest = await latestRes.json();
    const hourData = await Promise.all(hourResponses.map(r => r.json()));

    const idToName = {};
    if (Array.isArray(mapping)) mapping.forEach(m => { if (m && m.id != null && m.name != null) idToName[m.id] = m.name; });

    const itemStats = {};
    for (const res of hourData) {
      if (!res.data) continue;
      for (const [idStr, row] of Object.entries(res.data)) {
        if (!itemStats[idStr]) itemStats[idStr] = { volumes: [], spreads: [] };
        const vol = (row.highPriceVolume || 0) + (row.lowPriceVolume || 0);
        itemStats[idStr].volumes.push(vol);
        const high = row.avgHighPrice != null ? row.avgHighPrice : null;
        const low = row.avgLowPrice != null ? row.avgLowPrice : null;
        if (high != null && low != null) itemStats[idStr].spreads.push(high - low);
      }
    }

    const opportunities = [];
    const latestData = (latest && latest.data) ? latest.data : {};
    for (const [itemId, s] of Object.entries(itemStats)) {
      const volumes = s.volumes.filter(v => v > 0);
      const totalVol = volumes.reduce((a, b) => a + b, 0);
      const meanVol = volumes.length ? totalVol / volumes.length : 0;
      const volCV = meanVol > 0 ? stdDev(volumes) / meanVol : 999;
      const spreads = s.spreads.filter(x => x >= 0);
      const meanSpread = spreads.length ? spreads.reduce((a, b) => a + b, 0) / spreads.length : 0;
      const spreadCV = meanSpread > 0 ? stdDev(spreads) / meanSpread : 999;

      if (totalVol < minVol || volCV > maxVolCV || spreadCV > maxSpreadCV || volumes.length < 6 || spreads.length < 6) continue;

      const cur = latestData[itemId];
      const instabuy = cur && cur.high != null ? cur.high : null;
      const instasell = cur && cur.low != null ? cur.low : null;
      if (instabuy == null || instasell == null) continue;

      const margin = instabuy - instasell;
      opportunities.push({
        itemId,
        name: idToName[itemId] || "—",
        instabuy,
        instasell,
        margin,
        volCV,
        spreadCV
      });
    }

    opportunities.sort((a, b) => b.margin - a.margin);

    tbody.innerHTML = opportunities.length === 0
      ? "<tr><td colspan=\"6\" style=\"padding:12px;color:#888;\">No items match (try lowering min volume or raising max CV).</td></tr>"
      : opportunities.slice(0, 40).map(x => `
          <tr style="border-bottom:1px solid #333;">
            <td style="padding:10px 12px;">${(x.name || "—").replace(/</g, "&lt;")}</td>
            <td style="padding:10px 12px;text-align:right;">${x.instabuy.toLocaleString()}</td>
            <td style="padding:10px 12px;text-align:right;">${x.instasell.toLocaleString()}</td>
            <td style="padding:10px 12px;text-align:right;">${x.margin.toLocaleString()}</td>
            <td style="padding:10px 12px;text-align:right;">${(x.volCV * 100).toFixed(1)}%</td>
            <td style="padding:10px 12px;text-align:right;">${(x.spreadCV * 100).toFixed(1)}%</td>
          </tr>`).join("");

    updateLastUpdatedStamp();
  } catch (e) {
    tbody.innerHTML = "<tr><td colspan=\"6\" style=\"padding:12px;color:red;\">Error: " + (e && e.message ? e.message : "network") + "</td></tr>";
  }
}

/* RUN */

loadDashboard();

setInterval(loadDashboard, 60000);


</script>


</body>
</html>
