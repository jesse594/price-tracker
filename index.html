<!DOCTYPE html>
<html>

<head>
  <title>OSRS Trading Dashboard</title>
  <meta charset="UTF-8">
</head>

<body style="font-family:Arial;background:#111;color:#eee;padding:20px;">

<h1>OSRS Trading Dashboard</h1>


<!-- CURRENT POSITIONS -->

<h2>Open Positions</h2>

<table style="border-collapse:collapse;width:700px;">
  <thead>
    <tr style="border-bottom:1px solid #444;">
      <th style="padding:8px;text-align:left;">Item</th>
      <th style="padding:8px;text-align:right;">Buy Price</th>
      <th style="padding:8px;text-align:right;">Current Price</th>
      <th style="padding:8px;text-align:right;">Profit / Loss</th>
      <th style="padding:8px;text-align:right;">Signal</th>
    </tr>
  </thead>

  <tbody id="positions">
    <tr>
      <td colspan="5" style="padding:8px;color:#888;">
        Loading...
      </td>
    </tr>
  </tbody>

</table>



<!-- BUY OPPORTUNITIES -->

<h2 style="margin-top:40px;">Buy Opportunities (≤ 2M)</h2>

<table style="border-collapse:collapse;width:700px;">
  <thead>
    <tr style="border-bottom:1px solid #444;">
      <th style="padding:8px;text-align:left;">Item ID</th>
      <th style="padding:8px;text-align:right;">Current Price</th>
      <th style="padding:8px;text-align:right;">Upside %</th>
      <th style="padding:8px;text-align:right;">Signal</th>
    </tr>
  </thead>

  <tbody id="opportunities">
    <tr>
      <td colspan="4" style="padding:8px;color:#888;">
        Scanning market...
      </td>
    </tr>
  </tbody>

</table>



<!-- LOG TRADE PANEL -->

<div style="
position:fixed;
top:20px;
right:20px;
background:#1a1a1a;
padding:15px;
border:1px solid #333;
border-radius:6px;
width:220px;
">

<h3 style="margin-top:0;">Log Trade</h3>

<select id="log_trade_type"
style="width:100%;margin-bottom:8px;padding:6px;background:#222;color:#eee;border:1px solid #444;"
>
  <option value="buy">Buy</option>
  <option value="sell">Sell</option>
</select>

<input id="log_item_id"
placeholder="Item ID"
style="width:100%;margin-bottom:8px;padding:6px;background:#222;color:#eee;border:1px solid #444;"
>

<input id="log_item_name"
placeholder="Item Name"
style="width:100%;margin-bottom:8px;padding:6px;background:#222;color:#eee;border:1px solid #444;"
>

<input id="log_price"
type="number"
placeholder="Price"
style="width:100%;margin-bottom:8px;padding:6px;background:#222;color:#eee;border:1px solid #444;"
>

<input id="log_quantity"
type="number"
value="1"
placeholder="Quantity"
style="width:100%;margin-bottom:8px;padding:6px;background:#222;color:#eee;border:1px solid #444;"
>

<button onclick="logTrade()"
style="
width:100%;
padding:8px;
background:limegreen;
color:black;
border:none;
font-weight:bold;
cursor:pointer;
">
LOG TRADE
</button>

<div id="log_status"
style="margin-top:8px;font-size:12px;height:14px;">
</div>

</div>



<script>

const SUPABASE_URL =
"https://goabrqjuguybmvjlqylq.supabase.co";

const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvYWJycWp1Z3V5Ym12amxxeWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjMxOTgsImV4cCI6MjA4NjgzOTE5OH0.INEv8kOskPZO6fU6827a9XZkkl8Smzqht5_KVDzQ_Ro";



/* LOG TRADE FUNCTION */

async function logTrade() {

  const item_id =
  parseInt(
    document.getElementById("log_item_id").value
  );

  const item_name =
  document.getElementById("log_item_name").value.trim();

  const tradeType =
  document.getElementById("log_trade_type").value;

  const price =
  parseInt(
    document.getElementById("log_price").value
  );

  const quantity =
  parseInt(
    document.getElementById("log_quantity").value
  ) || 1;

  const statusEl =
  document.getElementById("log_status");


  if (!item_id || !item_name || !price) {

    statusEl.innerText =
    "Missing fields";

    statusEl.style.color =
    "red";

    return;

  }


  statusEl.innerText =
  "Logging...";

  statusEl.style.color =
  "orange";


  try {

    const res =
    await fetch(
      `${SUPABASE_URL}/rest/v1/trades`,
      {
        method: "POST",

        headers: {

          apikey:
          SUPABASE_KEY,

          Authorization:
          `Bearer ${SUPABASE_KEY}`,

          "Content-Type":
          "application/json",

          Prefer:
          "return=minimal"

        },

        body:
        JSON.stringify({

          item_id:
          item_id,

          item_name:
          item_name,

          side:
          tradeType,

          price:
          price,

          quantity:
          quantity,

          status:
          tradeType === "buy" ? "OPEN" : "CLOSED"

        })

      }
    );


    if (res.ok) {

      statusEl.innerText =
      "Logged ✓";

      statusEl.style.color =
      "limegreen";


      document.getElementById("log_item_id").value = "";
      document.getElementById("log_item_name").value = "";
      document.getElementById("log_price").value = "";
      document.getElementById("log_quantity").value = "1";


      loadDashboard();

    }

    else {

      statusEl.innerText =
      "Error";

      statusEl.style.color =
      "red";

    }

  }

  catch {

    statusEl.innerText =
    "Error";

    statusEl.style.color =
    "red";

  }

}





/* LOAD OPEN POSITIONS */

async function loadDashboard() {

  const tbody =
  document.getElementById("positions");

  try {

    const tradesRes =
    await fetch(
      `${SUPABASE_URL}/rest/v1/trades`,
      {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization:
          `Bearer ${SUPABASE_KEY}`
        }
      }
    );

    const allTrades =
    await tradesRes.json();


    const trades =
    allTrades.filter(
      t => t.status === "OPEN"
    );


    const priceRes =
    await fetch(
      "https://prices.runescape.wiki/api/v1/osrs/latest"
    );

    const priceData =
    await priceRes.json();


    if (trades.length === 0) {

      tbody.innerHTML = `
        <tr>
          <td colspan="5"
          style="padding:8px;color:#888;">
            No open positions
          </td>
        </tr>
      `;

      return;

    }


    tbody.innerHTML =
    trades.map(trade => {

      const market =
      priceData.data[trade.item_id];

      if (!market) return "";

      const current =
      Math.floor(
        (market.high + market.low) / 2
      );

      const buy =
      trade.buy_price;

      const profit =
      current - buy;

      const stopPrice =
      Math.floor(buy * 0.92);


      let signal =
      "HOLD";

      let signalColor =
      "orange";


      if (current <= stopPrice) {

        signal =
        "SELL";

        signalColor =
        "red";

      }


      const profitColor =
      profit >= 0
      ? "limegreen"
      : "red";


      return `

        <tr style="border-bottom:1px solid #222;">

          <td style="padding:8px;">
            ${trade.item_name}
          </td>

          <td style="padding:8px;text-align:right;">
            ${buy.toLocaleString()}
          </td>

          <td style="padding:8px;text-align:right;">
            ${current.toLocaleString()}
          </td>

          <td style="padding:8px;text-align:right;color:${profitColor};">
            ${profit.toLocaleString()}
          </td>

          <td style="padding:8px;text-align:right;">
            Stop: ${stopPrice.toLocaleString()}<br>
            <span style="color:${signalColor};font-weight:bold;">
            ${signal}
            </span>
          </td>

        </tr>

      `;

    }).join("");

  }

  catch {

    tbody.innerHTML =
    `<tr><td colspan="5" style="padding:8px;color:red;">
    Error loading dashboard
    </td></tr>`;

  }

}




/* LOAD BUY OPPORTUNITIES */

async function loadOpportunities() {

  const tbody =
  document.getElementById("opportunities");

  try {

    const latestRes =
    await fetch(
      "https://prices.runescape.wiki/api/v1/osrs/latest"
    );

    const latest =
    await latestRes.json();


    const fiveMinRes =
    await fetch(
      "https://prices.runescape.wiki/api/v1/osrs/5m"
    );

    const fiveMin =
    await fiveMinRes.json();


    const candidates =
    Object.entries(latest.data)
    .map(([itemId, price]) => {

      const current =
      Math.floor(
        (price.high + price.low) / 2
      );

      if (current > 2000000)
        return null;

      const history =
      fiveMin.data[itemId];

      if (!history)
        return null;

      const avgHigh =
      history.avgHighPrice;

      if (!avgHigh)
        return null;

      const upside =
      (avgHigh - current) / current;

      return {
        itemId,
        current,
        upside
      };

    })
    .filter(x => x && x.upside > 0.05)
    .sort((a,b) => b.upside - a.upside)
    .slice(0,10);



    tbody.innerHTML =
    candidates.map(item => {

      const upsidePercent =
      (item.upside * 100).toFixed(1);

      return `

        <tr style="border-bottom:1px solid #222;">

          <td style="padding:8px;">
            ${item.itemId}
          </td>

          <td style="padding:8px;text-align:right;">
            ${item.current.toLocaleString()}
          </td>

          <td style="padding:8px;text-align:right;color:limegreen;">
            ${upsidePercent}%
          </td>

          <td style="padding:8px;text-align:right;color:cyan;font-weight:bold;">
            BUY
          </td>

        </tr>

      `;

    }).join("");

  }

  catch {

    tbody.innerHTML =
    `<tr><td colspan="4" style="padding:8px;color:red;">
    Error scanning market
    </td></tr>`;

  }

}



/* RUN */

loadDashboard();
loadOpportunities();

setInterval(loadDashboard, 60000);
setInterval(loadOpportunities, 60000);


</script>


</body>
</html>
