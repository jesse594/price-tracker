<!DOCTYPE html>
<html>
<head>
  <title>OSRS Ontology Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial;
      background: #0b0f14;
      color: white;
      padding: 20px;
    }

    .card {
      background: #121821;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
    }

    .chart-container {
      width: 100%;
      max-width: 1000px;
      height: 500px;
    }

    .chart-container canvas {
      background: #121821;
      border-radius: 8px;
      padding: 10px;
    }

    .stat {
      font-size: 18px;
      margin: 5px 0;
    }

    .key {
      font-size: 13px;
      color: #8b9cad;
      margin-top: 6px;
      margin-bottom: 0;
    }

    .axis-note {
      font-size: 12px;
      color: #6b7c8d;
      margin-top: 8px;
    }
  </style>
</head>
<body>

<h1>Dragon Crossbow Ontology Dashboard</h1>

<div class="card">
  <div id="stats"></div>
  <p class="axis-note">All charts: data captured every 5 min; x-axis labels every 3 hours.</p>
</div>

<div class="card">
  <h3>Price</h3>
  <p class="key">Mid price (high + low) ÷ 2, in gp.</p>
  <div class="chart-container"><canvas id="priceChart"></canvas></div>
</div>

<div class="card">
  <h3>Spread</h3>
  <p class="key">Spread = high price − low price at each time (gp). Wider spread = more gap between buy and sell.</p>
  <div class="chart-container"><canvas id="spreadChart"></canvas></div>
</div>

<div class="card">
  <h3>Volume</h3>
  <p class="key">Number of trades (pieces) in the period.</p>
  <div class="chart-container"><canvas id="volumeChart"></canvas></div>
</div>

<script>

const SUPABASE_URL = "https://goabrqjuguybmvjlqylq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvYWJycWp1Z3V5Ym12amxxeWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjMxOTgsImV4cCI6MjA4NjgzOTE5OH0.INEv8kOskPZO6fU6827a9XZkkl8Smzqht5_KVDzQ_Ro";

const ITEM_ID = 21902;
const charts = {};

const STEP_EVERY_3_HOURS = 36;

function formatAxisLabel(unixSec) {
  const d = new Date(unixSec * 1000);
  const day = d.getDate();
  const month = d.toLocaleString("en", { month: "short" });
  const h = d.getHours();
  return day + " " + month + " " + String(h).padStart(2, "0") + ":00";
}

function chooseStepSize(range) {
  if (range <= 0) return 1;
  const approx = range / 8;
  const steps = [1, 2, 5, 10, 20, 50, 100, 250, 500, 1000, 2500, 5000, 10000, 25000, 50000, 100000, 250000, 500000, 1000000];
  for (const s of steps) {
    if (approx <= s) return s;
  }
  return steps[steps.length - 1];
}

async function loadData() {

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/prices?item_id=eq.${ITEM_ID}&order=timestamp.asc`,
    {
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`
      }
    }
  );

  const data = await res.json();

  if (!data || data.length === 0) {
    document.getElementById("stats").innerHTML = "<div class=\"stat\">No data yet.</div>";
    return;
  }

  const latest = data[data.length - 1];

  document.getElementById("stats").innerHTML = `
    <div class="stat">Price: ${latest.mid_price}</div>
    <div class="stat">Spread: ${latest.spread}</div>
    <div class="stat">Volume: ${latest.volume ?? 0}</div>
  `;

  createChart("priceChart", data, "mid_price", "Price", "rgb(0,200,255)");
  createChart("spreadChart", data, "spread", "Spread", "rgb(255,200,0)");
  createChart("volumeChart", data, "volume", "Volume", "rgb(0,255,100)");

}

function createChart(id, dataArray, valueKey, label, color) {

  if (charts[id]) {
    charts[id].destroy();
    charts[id] = null;
  }

  const values = dataArray.map(d => d[valueKey] ?? 0);
  const labels = dataArray.map((d, i) =>
    i % STEP_EVERY_3_HOURS === 0 ? formatAxisLabel(d.timestamp) : ""
  );

  const minVal = Math.min(...values);
  const maxVal = Math.max(...values);
  const range = maxVal - minVal || 1;
  const stepSize = chooseStepSize(range);

  charts[id] = new Chart(document.getElementById(id), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label,
        data: values,
        borderColor: color,
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          grid: {
            display: true,
            color: "rgba(255,255,255,0.12)",
            borderDash: [4, 4]
          },
          ticks: {
            color: "white",
            maxTicksLimit: 20,
            callback: function(_, i) { return labels[i] || ""; }
          }
        },
        y: {
          grid: {
            display: true,
            color: "rgba(255,255,255,0.12)",
            borderDash: [4, 4]
          },
          ticks: {
            color: "white",
            stepSize: stepSize
          },
          min: Math.floor(minVal / stepSize) * stepSize,
          max: Math.ceil(maxVal / stepSize) * stepSize
        }
      },
      plugins: {
        legend: {
          labels: { color: "white" }
        }
      }
    }
  });

}

loadData();

setInterval(loadData, 300000);

</script>

</body>
</html>
