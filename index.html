<!DOCTYPE html>
<html>
<head>
  <title>Price vs Expected Price</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>Seers Ring Price vs Expected Price</h2>

<div style="max-width:900px;height:400px;">
  <canvas id="chart"></canvas>
</div>

<script>

const SUPABASE_URL = "https://goabrqjuguybmvjlqylq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvYWJycWp1Z3V5Ym12amxxeWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjMxOTgsImV4cCI6MjA4NjgzOTE5OH0.INEv8kOskPZO6fU6827a9XZkkl8Smzqht5_KVDzQ_Ro";

const FIVE_MIN = 300;

function showError(msg) {
  const p = document.createElement("p");
  p.style.color = "#f88";
  p.textContent = msg;
  document.body.appendChild(p);
}

async function loadData() {
  try {
    const priceRes = await fetch(
      `${SUPABASE_URL}/rest/v1/prices?item_id=eq.6731&order=timestamp.asc`,
      {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
          Range: "0-99999"
        }
      }
    );
    if (!priceRes.ok) {
      showError("Prices: " + priceRes.status + " " + (await priceRes.text()).slice(0, 100));
      return;
    }
    const prices = await priceRes.json();
    if (!Array.isArray(prices) || prices.length === 0) {
      showError("No price data yet.");
      return;
    }

    let expected = [];
    try {
      const expectedRes = await fetch(
        `${SUPABASE_URL}/rest/v1/expected_prices?item_id=eq.6731&order=created_at.asc`,
        {
          headers: {
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`,
            Range: "0-99999"
          }
        }
      );
      if (expectedRes.ok) {
        const data = await expectedRes.json();
        expected = Array.isArray(data) ? data : [];
      }
    } catch (_) {}

    const labels = prices.map(p => new Date(p.timestamp * 1000).toLocaleTimeString());
    const realPrice = prices.map(p => p.mid_price);

    const expectedMap = {};
    expected.forEach(e => {
      if (e.expected_price == null) return;
      const ts = e.timestamp != null ? e.timestamp : (e.created_at ? Math.floor(new Date(e.created_at).getTime() / 1000) : null);
      if (ts == null || isNaN(ts)) return;
      const bucket = Math.floor(ts / FIVE_MIN) * FIVE_MIN;
      expectedMap[bucket] = e.expected_price;
    });

    const expectedPrice = prices.map(p => {
      const bucket = Math.floor(p.timestamp / FIVE_MIN) * FIVE_MIN;
      return expectedMap[bucket] ?? null;
    });

    drawChart(labels, realPrice, expectedPrice);
  } catch (e) {
    showError("Error: " + e.message);
  }
}

let chartInstance = null;

function drawChart(labels, realPrice, expectedPrice) {
  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }
  chartInstance = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        { label: "Real Price", data: realPrice, borderColor: "rgb(0,200,255)", tension: 0.1 },
        { label: "Expected Price", data: expectedPrice, borderColor: "rgb(255,200,0)", tension: 0.1 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}

loadData();

</script>

</body>
</html>
