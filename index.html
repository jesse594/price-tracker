<!DOCTYPE html>
<html>
<head>
  <title>Price vs Expected Price</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>Data status</h2>
<p style="color:#888;font-size:14px;">Latest row in each table — quick check that pipelines are running.</p>
<table id="lastUpdatedTable" style="border-collapse:collapse;margin-bottom:24px;min-width:320px;">
  <thead>
    <tr style="border-bottom:1px solid #333;">
      <th style="text-align:left;padding:8px 12px;">Table</th>
      <th style="text-align:left;padding:8px 12px;">Last updated</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="2" style="padding:8px 12px;color:#888;">Loading…</td></tr>
  </tbody>
</table>

<h2>Seers Ring Price vs Expected Price</h2>

<div style="max-width:900px;height:400px;">
  <canvas id="chart"></canvas>
</div>

<script>

const SUPABASE_URL = "https://goabrqjuguybmvjlqylq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvYWJycWp1Z3V5Ym12amxxeWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjMxOTgsImV4cCI6MjA4NjgzOTE5OH0.INEv8kOskPZO6fU6827a9XZkkl8Smzqht5_KVDzQ_Ro";

const FIVE_MIN = 300;

function showError(msg) {
  const p = document.createElement("p");
  p.style.color = "#f88";
  p.textContent = msg;
  document.body.appendChild(p);
}

async function loadData() {
  try {
    const priceRes = await fetch(
      `${SUPABASE_URL}/rest/v1/prices?item_id=eq.6731&order=timestamp.asc`,
      {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
          Range: "0-99999"
        }
      }
    );
    if (!priceRes.ok) {
      showError("Prices: " + priceRes.status + " " + (await priceRes.text()).slice(0, 100));
      return;
    }
    const prices = await priceRes.json();
    if (!Array.isArray(prices) || prices.length === 0) {
      showError("No price data yet.");
      return;
    }

    let expected = [];
    try {
      const expectedRes = await fetch(
        `${SUPABASE_URL}/rest/v1/expected_prices?item_id=eq.6731&order=created_at.asc`,
        {
          headers: {
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`,
            Range: "0-99999"
          }
        }
      );
      if (expectedRes.ok) {
        const data = await expectedRes.json();
        expected = Array.isArray(data) ? data : [];
      }
    } catch (_) {}

    const labels = prices.map(p => new Date(p.timestamp * 1000).toLocaleTimeString());
    const realPrice = prices.map(p => p.mid_price);

    const expectedMap = {};
    expected.forEach(e => {
      if (e.expected_price == null) return;
      const ts = e.timestamp != null ? e.timestamp : (e.last_updated || e.created_at ? Math.floor(new Date(e.last_updated || e.created_at).getTime() / 1000) : null);
      if (ts == null || isNaN(ts)) return;
      const bucket = Math.floor(ts / FIVE_MIN) * FIVE_MIN;
      expectedMap[bucket] = e.expected_price;
    });

    const expectedPrice = prices.map(p => {
      const bucket = Math.floor(p.timestamp / FIVE_MIN) * FIVE_MIN;
      return expectedMap[bucket] ?? null;
    });

    drawChart(labels, realPrice, expectedPrice);
  } catch (e) {
    showError("Error: " + e.message);
  }
}

let chartInstance = null;

function drawChart(labels, realPrice, expectedPrice) {
  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }
  chartInstance = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        { label: "Real Price", data: realPrice, borderColor: "rgb(0,200,255)", tension: 0.1 },
        { label: "Expected Price", data: expectedPrice, borderColor: "rgb(255,200,0)", tension: 0.1 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}

async function loadLastUpdated() {
  const headers = { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` };
  const rows = [
    { table: "prices", label: "prices" },
    { table: "expected_prices", label: "expected_prices" },
    { table: "price_models", label: "price_models" }
  ];

  const out = [];
  for (const { table, label } of rows) {
    let dateStr = "—";
    try {
      let url = "";
      let dateKey = "";
      if (table === "prices") {
        url = `${SUPABASE_URL}/rest/v1/prices?order=timestamp.desc`;
        dateKey = "timestamp";
      } else if (table === "expected_prices") {
        url = `${SUPABASE_URL}/rest/v1/expected_prices?order=last_updated.desc`;
        dateKey = "last_updated";
      } else if (table === "price_models") {
        url = `${SUPABASE_URL}/rest/v1/price_models?order=calculated_at.desc`;
        dateKey = "calculated_at";
      }
      const res = await fetch(url, { headers: { ...headers, Range: "0-0" } });
      if (res.ok) {
        const data = await res.json();
        const row = Array.isArray(data) ? data[0] : data;
        if (row) {
          const val = row[dateKey];
          if (val != null) {
            const d = typeof val === "number" ? new Date(val * 1000) : new Date(val);
            dateStr = d.toLocaleString();
          }
        }
      }
    } catch (_) {}
    out.push(`<tr style="border-bottom:1px solid #222;"><td style="padding:8px 12px;">${label}</td><td style="padding:8px 12px;">${dateStr}</td></tr>`);
  }

  const tbody = document.querySelector("#lastUpdatedTable tbody");
  if (tbody) tbody.innerHTML = out.join("");
}

loadLastUpdated();
loadData();
setInterval(loadLastUpdated, 60000);

</script>

</body>
</html>
