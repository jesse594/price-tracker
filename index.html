<!DOCTYPE html>
<html>

<head>
  <title>OSRS Trading Dashboard</title>
  <meta charset="UTF-8">
</head>

<body style="font-family:Arial;background:#111;color:#eee;padding:20px;">

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
  <h1 style="margin:0;">OSRS Trading Dashboard</h1>
  <span id="lastUpdatedStamp" style="font-size:11px;color:#666;">—</span>
</div>


<!-- OPEN TRADES -->

<section style="margin-bottom:32px;">
  <h2 style="margin-bottom:12px;font-size:1.25rem;">Open trades</h2>
  <table style="border-collapse:collapse;width:100%;max-width:720px;">
    <thead>
      <tr style="border-bottom:2px solid #444;">
        <th style="padding:10px 12px;text-align:left;">Item</th>
        <th style="padding:10px 12px;text-align:right;">Buy Price</th>
        <th style="padding:10px 12px;text-align:right;">Current Price</th>
        <th style="padding:10px 12px;text-align:right;">Profit / Loss</th>
        <th style="padding:10px 12px;text-align:right;">Signal</th>
        <th style="padding:10px 12px;text-align:center;">Close trade</th>
      </tr>
    </thead>
    <tbody id="openTradesBody">
      <tr>
        <td colspan="6" style="padding:12px;color:#888;">Loading…</td>
      </tr>
    </tbody>
  </table>
</section>

<!-- CLOSED TRADES -->

<section style="margin-bottom:32px;">
  <h2 style="margin-bottom:12px;font-size:1.25rem;">Closed trades</h2>
  <table style="border-collapse:collapse;width:100%;max-width:720px;">
    <thead>
      <tr style="border-bottom:2px solid #444;">
        <th style="padding:10px 12px;text-align:left;">Item</th>
        <th style="padding:10px 12px;text-align:right;">Buy Price</th>
        <th style="padding:10px 12px;text-align:right;">Sell Price</th>
        <th style="padding:10px 12px;text-align:right;">Profit / Loss</th>
      </tr>
    </thead>
    <tbody id="closedTradesBody">
      <tr>
        <td colspan="4" style="padding:12px;color:#888;">Loading…</td>
      </tr>
    </tbody>
  </table>
</section>

<!-- CLOSE TRADE MODAL -->

<div id="closeTradeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center;">
  <div style="background:#1a1a1a;border:1px solid #444;border-radius:8px;padding:24px;min-width:280px;">
    <h3 style="margin:0 0 16px 0;">Close this trade</h3>
    <p style="margin:0 0 8px 0;color:#aaa;">Item: <strong id="closeTradeItemName" style="color:#eee;"></strong></p>
    <p style="margin:0 0 16px 0;color:#aaa;">Buy price: <strong id="closeTradeBuyPrice" style="color:#eee;"></strong> GP</p>
    <label style="display:block;margin-bottom:6px;color:#aaa;font-size:14px;">Sell price (GP)</label>
    <input id="closeTradeSellPrice" type="number" min="0" placeholder="e.g. 1017240" style="width:100%;padding:8px;margin-bottom:16px;background:#222;color:#eee;border:1px solid #444;border-radius:4px;box-sizing:border-box;">
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button type="button" onclick="cancelCloseTrade()" style="padding:8px 16px;background:#333;color:#eee;border:1px solid #555;border-radius:4px;cursor:pointer;">Cancel</button>
      <button type="button" onclick="confirmCloseTrade()" style="padding:8px 16px;background:limegreen;color:#000;border:none;border-radius:4px;font-weight:bold;cursor:pointer;">Confirm</button>
    </div>
  </div>
</div>



<!-- BUY OPPORTUNITIES -->

<h2 style="margin-top:40px;">Buy Opportunities (≤ 2M)</h2>

<table style="border-collapse:collapse;width:700px;">
  <thead>
    <tr style="border-bottom:1px solid #444;">
      <th style="padding:8px;text-align:left;">Item ID</th>
      <th style="padding:8px;text-align:right;">Current Price</th>
      <th style="padding:8px;text-align:right;">Upside %</th>
      <th style="padding:8px;text-align:right;">Signal</th>
    </tr>
  </thead>

  <tbody id="opportunities">
    <tr>
      <td colspan="4" style="padding:8px;color:#888;">
        Scanning market...
      </td>
    </tr>
  </tbody>

</table>



<!-- LOG TRADE PANEL -->

<div style="
position:fixed;
top:20px;
right:20px;
background:#1a1a1a;
padding:15px;
border:1px solid #333;
border-radius:6px;
width:220px;
">

<h3 style="margin-top:0;">Log Trade</h3>

<select id="log_trade_type"
style="width:100%;margin-bottom:8px;padding:6px;background:#222;color:#eee;border:1px solid #444;"
>
  <option value="buy">Buy</option>
  <option value="sell">Sell</option>
</select>

<input id="log_item_id"
placeholder="Item ID"
style="width:100%;margin-bottom:8px;padding:6px;background:#222;color:#eee;border:1px solid #444;"
>

<input id="log_item_name"
placeholder="Item Name"
style="width:100%;margin-bottom:8px;padding:6px;background:#222;color:#eee;border:1px solid #444;"
>

<input id="log_price"
type="number"
placeholder="Price"
style="width:100%;margin-bottom:8px;padding:6px;background:#222;color:#eee;border:1px solid #444;"
>

<input id="log_quantity"
type="number"
value="1"
placeholder="Quantity"
style="width:100%;margin-bottom:8px;padding:6px;background:#222;color:#eee;border:1px solid #444;"
>

<button onclick="logTrade()"
style="
width:100%;
padding:8px;
background:limegreen;
color:black;
border:none;
font-weight:bold;
cursor:pointer;
">
LOG TRADE
</button>

<div id="log_status"
style="margin-top:8px;font-size:12px;height:14px;">
</div>

</div>



<script>

const SUPABASE_URL =
"https://goabrqjuguybmvjlqylq.supabase.co";

const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvYWJycWp1Z3V5Ym12amxxeWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjMxOTgsImV4cCI6MjA4NjgzOTE5OH0.INEv8kOskPZO6fU6827a9XZkkl8Smzqht5_KVDzQ_Ro";



/* LOG TRADE FUNCTION */

async function logTrade() {

  const item_id =
  parseInt(
    document.getElementById("log_item_id").value
  );

  const item_name =
  document.getElementById("log_item_name").value.trim();

  const tradeType =
  document.getElementById("log_trade_type").value;

  const price =
  parseInt(
    document.getElementById("log_price").value
  );

  const quantity =
  parseInt(
    document.getElementById("log_quantity").value
  ) || 1;

  const statusEl =
  document.getElementById("log_status");


  if (!item_id || !item_name || !price) {

    statusEl.innerText =
    "Missing fields";

    statusEl.style.color =
    "red";

    return;

  }


  statusEl.innerText =
  "Logging...";

  statusEl.style.color =
  "orange";


  try {

    const res =
    await fetch(
      `${SUPABASE_URL}/rest/v1/trades`,
      {
        method: "POST",

        headers: {

          apikey:
          SUPABASE_KEY,

          Authorization:
          `Bearer ${SUPABASE_KEY}`,

          "Content-Type":
          "application/json",

          Prefer:
          "return=minimal"

        },

        body:
        JSON.stringify({

          item_id:
          item_id,

          item_name:
          item_name,

          buy_price:
          price,

          quantity:
          quantity,

          status:
          tradeType === "buy" ? "OPEN" : "CLOSED"

        })

      }
    );


    if (res.ok) {

      statusEl.innerText =
      "Logged ✓";

      statusEl.style.color =
      "limegreen";


      document.getElementById("log_item_id").value = "";
      document.getElementById("log_item_name").value = "";
      document.getElementById("log_price").value = "";
      document.getElementById("log_quantity").value = "1";


      loadDashboard();

    }

    else {

      const errText =
      await res.text();

      statusEl.innerText =
      "Error " + res.status + ": " + (errText.slice(0, 80) || "check Supabase");

      statusEl.style.color =
      "red";

    }

  }

  catch (err) {

    statusEl.innerText =
    "Error: " + (err && err.message ? err.message : "network?");

    statusEl.style.color =
    "red";

  }

}





/* LOAD OPEN POSITIONS */

async function loadDashboard() {

  const openTbody =
  document.getElementById("openTradesBody");

  const closedTbody =
  document.getElementById("closedTradesBody");

  try {

    const tradesRes =
    await fetch(
      `${SUPABASE_URL}/rest/v1/trades`,
      {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization:
          `Bearer ${SUPABASE_KEY}`
        }
      }
    );

    const allTrades =
    await tradesRes.json();


    const priceRes =
    await fetch(
      "https://prices.runescape.wiki/api/v1/osrs/latest"
    );

    const priceData =
    await priceRes.json();


    updateLastUpdatedStamp();


    const openTrades =
    allTrades
    .filter(t => t.status === "OPEN")
    .sort((a, b) => (b.id || 0) - (a.id || 0));

    const closedTrades =
    allTrades
    .filter(t => t.status === "CLOSED" || (t.status !== "OPEN" && t.sell_price != null))
    .sort((a, b) => (b.id || 0) - (a.id || 0));


    if (openTrades.length === 0) {

      openTbody.innerHTML =
      `<tr><td colspan="6" style="padding:12px;color:#888;">No open trades</td></tr>`;

    } else {

      openTbody.innerHTML =
      openTrades.map(trade => {

        const market =
        priceData.data[trade.item_id];

        if (!market) return "";

        const current =
        Math.floor(
          (market.high + market.low) / 2
        );

        const buy =
        trade.buy_price;

        const profit =
        current - buy;

        const stopPrice =
        Math.floor(buy * 0.92);

        let signal =
        "HOLD";

        let signalColor =
        "orange";

        if (current <= stopPrice) {

          signal =
          "SELL";

          signalColor =
          "red";

        }

        const profitColor =
        profit >= 0 ? "limegreen" : "red";

        const itemNameEsc =
        (trade.item_name || "").replace(/"/g, "&quot;");

        return `<tr style="border-bottom:1px solid #333;">
            <td style="padding:10px 12px;">${trade.item_name}</td>
            <td style="padding:10px 12px;text-align:right;">${buy.toLocaleString()}</td>
            <td style="padding:10px 12px;text-align:right;">${current.toLocaleString()}</td>
            <td style="padding:10px 12px;text-align:right;color:${profitColor};">${profit.toLocaleString()}</td>
            <td style="padding:10px 12px;text-align:right;">Stop: ${stopPrice.toLocaleString()}<br><span style="color:${signalColor};font-weight:bold;">${signal}</span></td>
            <td style="padding:10px 12px;text-align:center;">
              <button onclick="openCloseTradeModal(this)" data-id="${trade.id}" data-item-name="${itemNameEsc}" data-buy-price="${buy}" style="padding:6px 12px;font-size:12px;cursor:pointer;background:#333;color:#eee;border:1px solid #555;border-radius:4px;">Close trade</button>
            </td>
          </tr>`;

      }).join("");

    }


    if (closedTrades.length === 0) {

      closedTbody.innerHTML =
      `<tr><td colspan="4" style="padding:12px;color:#888;">No closed trades</td></tr>`;

    } else {

      closedTbody.innerHTML =
      closedTrades.map(trade => {

        const buy =
        trade.buy_price;

        const sell =
        trade.sell_price;

        const profit =
        sell != null ? sell - buy : null;

        const profitColor =
        profit != null && profit >= 0 ? "limegreen" : profit != null ? "red" : "inherit";

        const profitStr =
        profit != null ? profit.toLocaleString() : "—";

        return `
          <tr style="border-bottom:1px solid #333;">
            <td style="padding:10px 12px;">${trade.item_name}</td>
            <td style="padding:10px 12px;text-align:right;">${buy.toLocaleString()}</td>
            <td style="padding:10px 12px;text-align:right;">${sell != null ? sell.toLocaleString() : "—"}</td>
            <td style="padding:10px 12px;text-align:right;color:${profitColor};">${profitStr}</td>
          </tr>
        `;

      }).join("");

    }

  }

  catch {

    openTbody.innerHTML =
    `<tr><td colspan="6" style="padding:12px;color:red;">Error loading trades</td></tr>`;

    closedTbody.innerHTML =
    `<tr><td colspan="4" style="padding:12px;color:red;">Error loading trades</td></tr>`;

  }

}


function updateLastUpdatedStamp() {

  const el =
  document.getElementById("lastUpdatedStamp");

  if (el)
  el.textContent =
  "Updated " + new Date().toLocaleString();

}


let closingTradeId = null;

function openCloseTradeModal(btn) {

  const id =
  parseInt(btn.getAttribute("data-id"), 10);

  const itemName =
  btn.getAttribute("data-item-name") || "";

  const buyPrice =
  btn.getAttribute("data-buy-price");

  closingTradeId = id;

  document.getElementById("closeTradeItemName").textContent = itemName;

  document.getElementById("closeTradeBuyPrice").textContent = buyPrice != null && buyPrice !== "" ? Number(buyPrice).toLocaleString() : "—";

  document.getElementById("closeTradeSellPrice").value = "";

  document.getElementById("closeTradeModal").style.display = "flex";

}

function cancelCloseTrade() {

  closingTradeId = null;

  document.getElementById("closeTradeModal").style.display = "none";

}

async function confirmCloseTrade() {

  if (closingTradeId == null)
  return;

  const sellPriceStr =
  document.getElementById("closeTradeSellPrice").value.trim();

  if (sellPriceStr === "") {

    alert("Enter sell price (GP).");

    return;

  }

  const sellPrice =
  parseInt(sellPriceStr, 10);

  if (isNaN(sellPrice) || sellPrice < 0) {

    alert("Enter a valid price.");

    return;

  }

  try {

    const res =
    await fetch(
      `${SUPABASE_URL}/rest/v1/trades?id=eq.${closingTradeId}`,
      {
        method: "PATCH",

        headers: {

          apikey: SUPABASE_KEY,

          Authorization:
          `Bearer ${SUPABASE_KEY}`,

          "Content-Type":
          "application/json"

        },

        body:
        JSON.stringify({

          sell_price: sellPrice,

          status: "CLOSED"

        })

      }
    );

    cancelCloseTrade();

    if (res.ok)
    loadDashboard();
    else {

      const errText =
      await res.text();

      alert("Error " + res.status + ": " + (errText.slice(0, 100) || "check Supabase"));

    }

  }
  catch (err) {

    alert("Error: " + (err && err.message ? err.message : "network?"));

  }

}




/* LOAD BUY OPPORTUNITIES */

async function loadOpportunities() {

  const tbody =
  document.getElementById("opportunities");

  try {

    const latestRes =
    await fetch(
      "https://prices.runescape.wiki/api/v1/osrs/latest"
    );

    const latest =
    await latestRes.json();


    const fiveMinRes =
    await fetch(
      "https://prices.runescape.wiki/api/v1/osrs/5m"
    );

    const fiveMin =
    await fiveMinRes.json();


    const candidates =
    Object.entries(latest.data)
    .map(([itemId, price]) => {

      const current =
      Math.floor(
        (price.high + price.low) / 2
      );

      if (current > 2000000)
        return null;

      const history =
      fiveMin.data[itemId];

      if (!history)
        return null;

      const avgHigh =
      history.avgHighPrice;

      if (!avgHigh)
        return null;

      const upside =
      (avgHigh - current) / current;

      return {
        itemId,
        current,
        upside
      };

    })
    .filter(x => x && x.upside > 0.05)
    .sort((a,b) => b.upside - a.upside)
    .slice(0,10);



    tbody.innerHTML =
    candidates.map(item => {

      const upsidePercent =
      (item.upside * 100).toFixed(1);

      return `

        <tr style="border-bottom:1px solid #222;">

          <td style="padding:8px;">
            ${item.itemId}
          </td>

          <td style="padding:8px;text-align:right;">
            ${item.current.toLocaleString()}
          </td>

          <td style="padding:8px;text-align:right;color:limegreen;">
            ${upsidePercent}%
          </td>

          <td style="padding:8px;text-align:right;color:cyan;font-weight:bold;">
            BUY
          </td>

        </tr>

      `;

    }).join("");

    updateLastUpdatedStamp();

  }

  catch {

    tbody.innerHTML =
    `<tr><td colspan="4" style="padding:8px;color:red;">
    Error scanning market
    </td></tr>`;

  }

}



/* RUN */

loadDashboard();
loadOpportunities();

setInterval(loadDashboard, 60000);
setInterval(loadOpportunities, 60000);


</script>


</body>
</html>
