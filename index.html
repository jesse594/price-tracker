<!DOCTYPE html>
<html>
<head>
  <title>OSRS Ontology Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial;
      background: #0b0f14;
      color: white;
      padding: 20px;
    }

    .card {
      background: #121821;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
    }

    canvas {
      background: #121821;
      border-radius: 8px;
      padding: 10px;
    }

    .stat {
      font-size: 18px;
      margin: 5px 0;
    }
  </style>
</head>
<body>

<h1>Dragon Crossbow Ontology Dashboard</h1>

<div class="card">
  <div id="stats"></div>
</div>

<div class="card">
  <h3>Price</h3>
  <canvas id="priceChart"></canvas>
</div>

<div class="card">
  <h3>Spread</h3>
  <canvas id="spreadChart"></canvas>
</div>

<div class="card">
  <h3>Volume</h3>
  <canvas id="volumeChart"></canvas>
</div>

<script>

const SUPABASE_URL = "https://goabrqjuguybmvjlqylq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvYWJycWp1Z3V5Ym12amxxeWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjMxOTgsImV4cCI6MjA4NjgzOTE5OH0.INEv8kOskPZO6fU6827a9XZkkl8Smzqht5_KVDzQ_Ro";

const ITEM_ID = 21902;
const charts = {};

async function loadData() {

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/prices?item_id=eq.${ITEM_ID}&order=timestamp.asc`,
    {
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`
      }
    }
  );

  const data = await res.json();

  if (!data || data.length === 0) {
    document.getElementById("stats").innerHTML = "<div class=\"stat\">No data yet.</div>";
    return;
  }

  const timestamps = data.map(x => new Date(x.timestamp * 1000).toLocaleTimeString());
  const prices = data.map(x => x.mid_price);
  const spreads = data.map(x => x.spread);
  const volumes = data.map(x => x.volume ?? 0);

  const latest = data[data.length - 1];

  document.getElementById("stats").innerHTML = `
    <div class="stat">Price: ${latest.mid_price}</div>
    <div class="stat">Spread: ${latest.spread}</div>
    <div class="stat">Volume: ${latest.volume ?? 0}</div>
  `;

  createChart("priceChart", timestamps, prices, "Price", "rgb(0,200,255)");
  createChart("spreadChart", timestamps, spreads, "Spread", "rgb(255,200,0)");
  createChart("volumeChart", timestamps, volumes, "Volume", "rgb(0,255,100)");

}

function createChart(id, labels, data, label, color) {

  if (charts[id]) {
    charts[id].destroy();
    charts[id] = null;
  }

  charts[id] = new Chart(document.getElementById(id), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label,
        data,
        borderColor: color,
        tension: 0.1
      }]
    },
    options: {
      scales: {
        x: { ticks: { color: "white" }},
        y: { ticks: { color: "white" }}
      },
      plugins: {
        legend: {
          labels: { color: "white" }
        }
      }
    }
  });

}

loadData();

setInterval(loadData, 300000);

</script>

</body>
</html>
