<!DOCTYPE html>
<html>

<head>
  <title>OSRS Trading Dashboard</title>
  <meta charset="UTF-8">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #f6f4f0;
      color: #1a1a1a;
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }
    .app { max-width: 960px; margin: 0 auto; padding: 32px 24px 80px; }
    .banner {
      background: linear-gradient(90deg, #ff8c42 0%, #a855f7 100%);
      color: #fff;
      text-align: center;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 0 32px;
      border-bottom: 1px solid #e5e2dc;
    }
    .header h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color: #1a1a1a; }
    .header .muted { font-size: 12px; color: #6b7280; }
    .section {
      margin-bottom: 40px;
      padding-top: 28px;
    }
    .section-title { margin: 0 0 8px 0; font-size: 1.2rem; font-weight: 600; color: #1a1a1a; }
    .section-desc { color: #6b7280; font-size: 14px; margin-bottom: 16px; }
    .dashboard-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      border: 1px solid #e5e2dc;
    }
    .dashboard-table th {
      text-align: left;
      padding: 14px 16px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #6b7280;
      background: #faf9f7;
      border-bottom: 1px solid #e5e2dc;
    }
    .dashboard-table th[style*="text-align:right"],
    .dashboard-table td[style*="text-align:right"] { text-align: right; }
    .dashboard-table td { padding: 14px 16px; border-bottom: 1px solid #eee; color: #1a1a1a; font-size: 14px; }
    .dashboard-table tbody tr:last-child td { border-bottom: none; }
    .dashboard-table tbody tr:hover { background: #faf9f7; }
    .btn-outline {
      padding: 10px 18px;
      background: #fff;
      color: #1a1a1a;
      border: 1.5px solid #1a1a1a;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    .btn-outline:hover { background: #1a1a1a; color: #fff; }
    .btn-primary {
      padding: 12px 20px;
      background: #22c55e;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .btn-primary:hover { background: #16a34a; }
    .form-input, .form-select {
      width: 100%;
      padding: 10px 12px;
      background: #fff;
      color: #1a1a1a;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    }
    .log-trade-panel input,
    .log-trade-panel select { box-sizing: border-box; border-radius: 8px; transition: border-color 0.15s, box-shadow 0.15s; }
    .log-trade-panel input:focus,
    .log-trade-panel select:focus { outline: none; border-color: #22c55e; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2); }
    .log-trade-panel button { border-radius: 8px; transition: background 0.15s, transform 0.05s; }
    .log-trade-panel button:hover { background: #16a34a !important; }
    .log-trade-panel button:active { transform: scale(0.98); }
    .log-trade-panel .log-field-label {
      display: block;
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 6px;
    }
    .log-item-suggestion:hover { background: #f6f4f0; }
  </style>
</head>

<body>

<div class="banner">→ OSRS Grand Exchange price tracker</div>

<div class="app">
<div class="header">
  <h1>OSRS Trading</h1>
  <span id="lastUpdatedStamp" class="muted">—</span>
</div>


<!-- OPEN TRADES -->

<section class="section">
  <h2 class="section-title">Open trades</h2>
  <table class="dashboard-table" style="max-width:720px;">
    <thead>
      <tr>
        <th style="text-align:left;">Item</th>
        <th style="text-align:left;">Date</th>
        <th style="text-align:right;">Buy Price</th>
        <th style="text-align:right;">Total price</th>
        <th style="text-align:right;">Current Price</th>
        <th style="text-align:right;">Profit / Loss</th>
        <th style="text-align:right;">Signal</th>
        <th style="text-align:center;">Close trade</th>
      </tr>
    </thead>
    <tbody id="openTradesBody">
      <tr>
        <td colspan="8" style="padding:14px 16px;color:#6b7280;">Loading…</td>
      </tr>
    </tbody>
  </table>
</section>

<!-- CLOSED TRADES -->

<section class="section">
  <h2 class="section-title">Closed trades</h2>
  <table class="dashboard-table" style="max-width:720px;">
    <thead>
      <tr>
        <th style="text-align:left;">Item</th>
        <th style="text-align:left;">Date</th>
        <th style="text-align:right;">Buy Price</th>
        <th style="text-align:right;">Total buy</th>
        <th style="text-align:right;">Sell Price</th>
        <th style="text-align:right;">Total sell</th>
        <th style="text-align:right;">Profit / Loss</th>
      </tr>
    </thead>
    <tbody id="closedTradesBody">
      <tr>
        <td colspan="7" style="padding:14px 16px;color:#6b7280;">Loading…</td>
      </tr>
    </tbody>
  </table>
</section>

<!-- STABLE OPPORTUNITIES -->

<section class="section">
  <h2 class="section-title">Stable opportunities</h2>
  <p class="section-desc">Items with stable volume and stable spread (last 12h). Instabuy = price to buy now; Instasell = price you get selling now.</p>
  <div style="margin-bottom:16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
    <label style="display:flex;align-items:center;gap:6px;font-size:14px;color:#6b7280;"><span>Min volume (12h)</span><input type="number" id="stableOppMinVolume" value="100000" min="0" class="form-input" style="width:100px;"></label>
    <label style="display:flex;align-items:center;gap:6px;font-size:14px;color:#6b7280;"><span>Max vol CV</span><input type="number" id="stableOppMaxVolCV" value="0.35" min="0" step="0.05" class="form-input" style="width:70px;"></label>
    <label style="display:flex;align-items:center;gap:6px;font-size:14px;color:#6b7280;"><span>Max spread CV</span><input type="number" id="stableOppMaxSpreadCV" value="0.15" min="0" step="0.05" class="form-input" style="width:70px;"></label>
    <button type="button" onclick="loadStableOpportunities()" class="btn-outline">Scan</button>
  </div>
  <table class="dashboard-table" style="max-width:900px;">
    <thead>
      <tr>
        <th style="text-align:left;">Item</th>
        <th style="text-align:right;">Instabuy</th>
        <th style="text-align:right;">Instasell</th>
        <th style="text-align:right;">1h avg buy</th>
        <th style="text-align:right;">1h avg sell</th>
        <th style="text-align:right;">Margin</th>
        <th style="text-align:right;">Vol CV</th>
        <th style="text-align:right;">Spread CV</th>
      </tr>
    </thead>
    <tbody id="stableOpportunitiesBody">
      <tr><td colspan="8" style="padding:14px 16px;color:#6b7280;">Run Scan to load.</td></tr>
    </tbody>
  </table>
  <p style="margin-top:8px;font-size:12px;color:#6b7280;">Instabuy/instasell = last known trade (age shows freshness). 1h avg = last hour average; compare to spot for impact.</p>
</section>

</div>

<!-- CLOSE TRADE MODAL -->

<div id="closeTradeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:100;align-items:center;justify-content:center;">
  <div style="background:#fff;border:1px solid #e5e2dc;border-radius:12px;padding:24px;min-width:300px;box-shadow:0 10px 40px rgba(0,0,0,0.12);">
    <h3 style="margin:0 0 16px 0;color:#1a1a1a;">Close this trade</h3>
    <p style="margin:0 0 8px 0;color:#6b7280;">Item: <strong id="closeTradeItemName" style="color:#1a1a1a;"></strong></p>
    <p style="margin:0 0 16px 0;color:#6b7280;">Buy price: <strong id="closeTradeBuyPrice" style="color:#1a1a1a;"></strong> GP</p>
    <label style="display:block;margin-bottom:6px;color:#6b7280;font-size:14px;">Sell price (GP)</label>
    <input id="closeTradeSellPrice" type="number" min="0" placeholder="e.g. 1017240" class="form-input" style="width:100%;margin-bottom:16px;">
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button type="button" onclick="cancelCloseTrade()" class="btn-outline">Cancel</button>
      <button type="button" onclick="confirmCloseTrade()" class="btn-primary">Confirm</button>
    </div>
  </div>
</div>



<!-- LOG TRADE PANEL -->

<div class="log-trade-panel" style="
  position: fixed;
  top: 20px;
  right: 20px;
  background: #fff;
  padding: 22px 24px;
  border: 1px solid #e5e2dc;
  border-radius: 12px;
  width: 280px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.08);
">

  <h3 style="margin: 0 0 20px 0; font-size: 1.1rem; font-weight: 600; color: #1a1a1a;">Log Trade</h3>

  <label class="log-field-label" for="log_trade_type">Type</label>
  <select id="log_trade_type" class="form-select" style="width:100%;margin-bottom:14px;">
    <option value="buy">Buy</option>
    <option value="sell">Sell</option>
  </select>

  <label class="log-field-label" for="log_item_name">Item name</label>
  <div style="position:relative;">
    <input id="log_item_name" class="form-input" placeholder="Type to search, then pick from list" autocomplete="off" style="width:100%;margin-bottom:0;">
    <div id="log_item_suggestions" style="display:none;position:absolute;left:0;right:0;top:100%;z-index:200;max-height:220px;overflow-y:auto;background:#fff;border:1px solid #e5e2dc;border-top:none;border-radius:0 0 8px 8px;box-shadow:0 8px 24px rgba(0,0,0,0.1);"></div>
  </div>
  <label class="log-field-label" for="log_item_id">Item ID</label>
  <input id="log_item_id" type="text" class="form-input" placeholder="Filled when you pick above (or type manually)" style="width:100%;margin-bottom:14px;font-size:13px;">

  <label class="log-field-label" for="log_price">Price (GP)</label>
  <input id="log_price" type="number" min="0" class="form-input" placeholder="e.g. 741000" style="width:100%;margin-bottom:14px;">

  <label class="log-field-label" for="log_quantity">Quantity</label>
  <input id="log_quantity" type="number" min="1" value="1" class="form-input" style="width:100%;margin-bottom:20px;">

  <button onclick="logTrade()" class="btn-primary" style="width:100%;">Log trade</button>

  <div id="log_status" style="margin-top:12px;font-size:12px;min-height:16px;color:#6b7280;"></div>

</div>



<script>

const SUPABASE_URL =
"https://goabrqjuguybmvjlqylq.supabase.co";

const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvYWJycWp1Z3V5Ym12amxxeWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjMxOTgsImV4cCI6MjA4NjgzOTE5OH0.INEv8kOskPZO6fU6827a9XZkkl8Smzqht5_KVDzQ_Ro";

const WIKI_HEADERS = { "User-Agent": "OSRS-Price-Tracker/1.0 (https://github.com/jesse594/price-tracker)", "Accept": "application/json" };

let itemMappingCache = null;

async function getItemMapping() {
  if (itemMappingCache) return itemMappingCache;
  const res = await fetch("https://prices.runescape.wiki/api/v1/osrs/mapping", { headers: WIKI_HEADERS });
  const list = await res.json();
  itemMappingCache = Array.isArray(list) ? list.filter(m => m && m.id != null && m.name) : [];
  return itemMappingCache;
}

function showItemSuggestions(query) {
  const list = document.getElementById("log_item_suggestions");
  const nameInput = document.getElementById("log_item_name");
  if (!query || query.length < 2) { list.innerHTML = ""; list.style.display = "none"; return; }
  getItemMapping().then(mapping => {
    const q = query.toLowerCase().trim();
    const matches = mapping.filter(m => m.name.toLowerCase().includes(q)).slice(0, 20);
    list.innerHTML = matches.length === 0
      ? "<div style=\"padding:8px 10px;color:#6b7280;\">No matches</div>"
      : matches.map(m => `<div class="log-item-suggestion" data-id="${m.id}" data-name="${(m.name || "").replace(/"/g, "&quot;")}" style="padding:8px 10px;cursor:pointer;border-bottom:1px solid #eee;color:#1a1a1a;">${(m.name || "").replace(/</g, "&lt;")} <span style="color:#6b7280;font-size:11px;">(${m.id})</span></div>`).join("");
    list.style.display = "block";
    list.querySelectorAll(".log-item-suggestion").forEach(el => {
      el.addEventListener("click", () => {
        nameInput.value = el.getAttribute("data-name");
        document.getElementById("log_item_id").value = el.getAttribute("data-id");
        list.innerHTML = "";
        list.style.display = "none";
      });
    });
  });
}

/* LOG TRADE FUNCTION */

async function logTrade() {

  const item_id =
  parseInt(
    document.getElementById("log_item_id").value
  );

  const item_name =
  document.getElementById("log_item_name").value.trim();

  const tradeType =
  document.getElementById("log_trade_type").value;

  const price =
  parseInt(
    document.getElementById("log_price").value
  );

  const quantity =
  parseInt(
    document.getElementById("log_quantity").value
  ) || 1;

  const statusEl =
  document.getElementById("log_status");


  if (!item_id || !item_name || !price) {

    statusEl.innerText =
    "Missing fields";

    statusEl.style.color =
    "red";

    return;

  }


  statusEl.innerText =
  "Logging...";

  statusEl.style.color =
  "orange";


  try {

    const res =
    await fetch(
      `${SUPABASE_URL}/rest/v1/trades`,
      {
        method: "POST",

        headers: {

          apikey:
          SUPABASE_KEY,

          Authorization:
          `Bearer ${SUPABASE_KEY}`,

          "Content-Type":
          "application/json",

          Prefer:
          "return=minimal"

        },

        body:
        JSON.stringify({

          item_id:
          item_id,

          item_name:
          item_name,

          buy_price:
          price,

          quantity:
          quantity,

          status:
          tradeType === "buy" ? "OPEN" : "CLOSED"

        })

      }
    );


    if (res.ok) {

      statusEl.innerText =
      "Logged ✓";

      statusEl.style.color =
      "limegreen";


      document.getElementById("log_item_id").value = "";
      document.getElementById("log_item_name").value = "";
      document.getElementById("log_price").value = "";
      document.getElementById("log_quantity").value = "1";


      loadDashboard();

    }

    else {

      const errText =
      await res.text();

      statusEl.innerText =
      "Error " + res.status + ": " + (errText.slice(0, 80) || "check Supabase");

      statusEl.style.color =
      "red";

    }

  }

  catch (err) {

    statusEl.innerText =
    "Error: " + (err && err.message ? err.message : "network?");

    statusEl.style.color =
    "red";

  }

}





function formatTradeDate(isoString) {
  if (!isoString) return "—";
  const d = new Date(isoString);
  if (isNaN(d.getTime())) return "—";
  const day = d.getDate();
  const ord = day === 1 || day === 21 || day === 31 ? "st" : day === 2 || day === 22 ? "nd" : day === 3 || day === 23 ? "rd" : "th";
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return day + ord + " " + months[d.getMonth()];
}

/* LOAD OPEN POSITIONS */

async function loadDashboard() {

  const openTbody =
  document.getElementById("openTradesBody");

  const closedTbody =
  document.getElementById("closedTradesBody");

  try {

    const tradesRes =
    await fetch(
      `${SUPABASE_URL}/rest/v1/trades`,
      {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization:
          `Bearer ${SUPABASE_KEY}`
        }
      }
    );

    const allTrades =
    await tradesRes.json();


    const priceRes =
    await fetch(
      "https://prices.runescape.wiki/api/v1/osrs/latest"
    );

    const priceData =
    await priceRes.json();


    updateLastUpdatedStamp();


    const openTrades =
    allTrades
    .filter(t => t.status === "OPEN")
    .sort((a, b) => (b.id || 0) - (a.id || 0));

    const closedTrades =
    allTrades
    .filter(t => t.status === "CLOSED" || (t.status !== "OPEN" && t.sell_price != null))
    .sort((a, b) => (b.id || 0) - (a.id || 0));


    if (openTrades.length === 0) {

      openTbody.innerHTML =
      `<tr><td colspan="8" style="padding:14px 16px;color:#6b7280;">No open trades</td></tr>`;

    } else {

      openTbody.innerHTML =
      openTrades.map(trade => {

        const market =
        priceData.data[trade.item_id];

        if (!market) return "";

        const current =
        Math.floor(
          (market.high + market.low) / 2
        );

        const buy =
        trade.buy_price;

        const qty =
        Math.max(1, parseInt(trade.quantity, 10) || 1);

        const profit =
        (current - buy) * qty;

        const stopPrice =
        Math.floor(buy * 0.92);

        let signal =
        "HOLD";

        let signalColor =
        "orange";

        if (current <= stopPrice) {

          signal =
          "SELL";

          signalColor =
          "red";

        }

        const profitColor =
        profit >= 0 ? "limegreen" : "red";

        const itemNameEsc =
        (trade.item_name || "").replace(/"/g, "&quot;");

        const totalPrice = buy * qty;
        return `<tr style="border-bottom:1px solid #eee;">
            <td style="padding:14px 16px;">${trade.item_name}</td>
            <td style="padding:14px 16px;">${formatTradeDate(trade.buy_time)}</td>
            <td style="padding:14px 16px;text-align:right;">${buy.toLocaleString()}</td>
            <td style="padding:14px 16px;text-align:right;">${totalPrice.toLocaleString()}</td>
            <td style="padding:14px 16px;text-align:right;">${current.toLocaleString()}</td>
            <td style="padding:14px 16px;text-align:right;color:${profitColor};">${profit.toLocaleString()}</td>
            <td style="padding:14px 16px;text-align:right;">Stop: ${stopPrice.toLocaleString()}<br><span style="color:${signalColor};font-weight:bold;">${signal}</span></td>
            <td style="padding:14px 16px;text-align:center;">
              <button onclick="openCloseTradeModal(this)" data-id="${trade.id}" data-item-name="${itemNameEsc}" data-buy-price="${buy}" class="btn-outline" style="padding:6px 12px;font-size:12px;cursor:pointer;">Close trade</button>
            </td>
          </tr>`;

      }).join("");

    }


    if (closedTrades.length === 0) {

      closedTbody.innerHTML =
      `<tr><td colspan="7" style="padding:14px 16px;color:#6b7280;">No closed trades</td></tr>`;

    } else {

      closedTbody.innerHTML =
      closedTrades.map(trade => {

        const buy =
        trade.buy_price;

        const sell =
        trade.sell_price;

        const qty =
        Math.max(1, parseInt(trade.quantity, 10) || 1);

        const profit =
        sell != null ? (sell - buy) * qty : null;

        const profitColor =
        profit != null && profit >= 0 ? "limegreen" : profit != null ? "red" : "inherit";

        const profitStr =
        profit != null ? profit.toLocaleString() : "—";

        const totalBuy = buy * qty;
        const totalSell = sell != null ? sell * qty : null;
        return `
          <tr style="border-bottom:1px solid #eee;">
            <td style="padding:14px 16px;">${trade.item_name}</td>
            <td style="padding:14px 16px;">${formatTradeDate(trade.buy_time)}</td>
            <td style="padding:14px 16px;text-align:right;">${buy.toLocaleString()}</td>
            <td style="padding:14px 16px;text-align:right;">${totalBuy.toLocaleString()}</td>
            <td style="padding:14px 16px;text-align:right;">${sell != null ? sell.toLocaleString() : "—"}</td>
            <td style="padding:14px 16px;text-align:right;">${totalSell != null ? totalSell.toLocaleString() : "—"}</td>
            <td style="padding:14px 16px;text-align:right;color:${profitColor};">${profitStr}</td>
          </tr>
        `;

      }).join("");

    }

  }

  catch {

    openTbody.innerHTML =
    `<tr><td colspan="8" style="padding:14px 16px;color:#dc2626;">Error loading trades</td></tr>`;

    closedTbody.innerHTML =
    `<tr><td colspan="7" style="padding:14px 16px;color:#dc2626;">Error loading trades</td></tr>`;

  }

}


function updateLastUpdatedStamp() {

  const el =
  document.getElementById("lastUpdatedStamp");

  if (el)
  el.textContent =
  "Updated " + new Date().toLocaleString();

}


let closingTradeId = null;

function openCloseTradeModal(btn) {

  const id =
  btn.getAttribute("data-id");

  const itemName =
  btn.getAttribute("data-item-name") || "";

  const buyPrice =
  btn.getAttribute("data-buy-price");

  closingTradeId = id;

  document.getElementById("closeTradeItemName").textContent = itemName;

  document.getElementById("closeTradeBuyPrice").textContent = buyPrice != null && buyPrice !== "" ? Number(buyPrice).toLocaleString() : "—";

  document.getElementById("closeTradeSellPrice").value = "";

  document.getElementById("closeTradeModal").style.display = "flex";

}

function cancelCloseTrade() {

  closingTradeId = null;

  document.getElementById("closeTradeModal").style.display = "none";

}

async function confirmCloseTrade() {

  if (closingTradeId == null)
  return;

  const sellPriceStr =
  document.getElementById("closeTradeSellPrice").value.trim();

  if (sellPriceStr === "") {

    alert("Enter sell price (GP).");

    return;

  }

  const sellPrice =
  parseInt(sellPriceStr, 10);

  if (isNaN(sellPrice) || sellPrice < 0) {

    alert("Enter a valid price.");

    return;

  }

  try {

    const res =
    await fetch(
      `${SUPABASE_URL}/rest/v1/trades?id=eq.${encodeURIComponent(closingTradeId)}`,
      {
        method: "PATCH",

        headers: {

          apikey: SUPABASE_KEY,

          Authorization:
          `Bearer ${SUPABASE_KEY}`,

          "Content-Type":
          "application/json"

        },

        body:
        JSON.stringify({

          sell_price: sellPrice,

          status: "CLOSED"

        })

      }
    );

    cancelCloseTrade();

    if (res.ok)
    loadDashboard();
    else {

      const errText =
      await res.text();

      alert("Error " + res.status + ": " + (errText.slice(0, 100) || "check Supabase"));

    }

  }
  catch (err) {

    alert("Error: " + (err && err.message ? err.message : "network?"));

  }

}




function stdDev(arr) {
  if (arr.length === 0) return 0;
  const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
  const sq = arr.map(x => (x - mean) ** 2).reduce((a, b) => a + b, 0);
  return Math.sqrt(sq / arr.length);
}

function timeAgo(unixSec) {
  if (unixSec == null || !unixSec) return "—";
  const sec = Math.floor(Date.now() / 1000) - Number(unixSec);
  if (sec < 30) return "just now";
  if (sec < 60) return sec + "s ago";
  const min = Math.floor(sec / 60);
  if (min < 60) return min + "m ago";
  const hr = Math.floor(min / 60);
  if (hr < 24) return hr + "h ago";
  return Math.floor(hr / 24) + "d ago";
}

async function loadStableOpportunities() {
  const tbody = document.getElementById("stableOpportunitiesBody");
  const minVol = Number(document.getElementById("stableOppMinVolume").value) || 100000;
  const maxVolCV = Number(document.getElementById("stableOppMaxVolCV").value) || 0.35;
  const maxSpreadCV = Number(document.getElementById("stableOppMaxSpreadCV").value) || 0.15;

  tbody.innerHTML = "<tr><td colspan=\"8\" style=\"padding:14px 16px;color:#6b7280;\">Loading 12h + latest…</td></tr>";

  try {
    const nowSec = Math.floor(Date.now() / 1000);
    const startOfCurrentHour = Math.floor(nowSec / 3600) * 3600;
    const timestamps = [];
    for (let i = 0; i < 12; i++) timestamps.push(startOfCurrentHour - i * 3600);

    const [mappingRes, latestRes, ...hourResponses] = await Promise.all([
      fetch("https://prices.runescape.wiki/api/v1/osrs/mapping", { headers: WIKI_HEADERS }),
      fetch("https://prices.runescape.wiki/api/v1/osrs/latest", { headers: WIKI_HEADERS }),
      ...timestamps.map(ts => fetch("https://prices.runescape.wiki/api/v1/osrs/1h?timestamp=" + ts, { headers: WIKI_HEADERS }))
    ]);

    const mapping = await mappingRes.json();
    const latest = await latestRes.json();
    const hourData = await Promise.all(hourResponses.map(r => r.json()));

    const idToName = {};
    if (Array.isArray(mapping)) mapping.forEach(m => { if (m && m.id != null && m.name != null) idToName[m.id] = m.name; });

    const itemStats = {};
    for (const res of hourData) {
      if (!res.data) continue;
      for (const [idStr, row] of Object.entries(res.data)) {
        if (!itemStats[idStr]) itemStats[idStr] = { volumes: [], spreads: [] };
        const vol = (row.highPriceVolume || 0) + (row.lowPriceVolume || 0);
        itemStats[idStr].volumes.push(vol);
        const high = row.avgHighPrice != null ? row.avgHighPrice : null;
        const low = row.avgLowPrice != null ? row.avgLowPrice : null;
        if (high != null && low != null) itemStats[idStr].spreads.push(high - low);
      }
    }

    const opportunities = [];
    const latestData = (latest && latest.data) ? latest.data : {};
    const recent1h = (hourData && hourData[0] && hourData[0].data) ? hourData[0].data : {};
    for (const [itemId, s] of Object.entries(itemStats)) {
      const volumes = s.volumes.filter(v => v > 0);
      const totalVol = volumes.reduce((a, b) => a + b, 0);
      const meanVol = volumes.length ? totalVol / volumes.length : 0;
      const volCV = meanVol > 0 ? stdDev(volumes) / meanVol : 999;
      const spreads = s.spreads.filter(x => x >= 0);
      const meanSpread = spreads.length ? spreads.reduce((a, b) => a + b, 0) / spreads.length : 0;
      const spreadCV = meanSpread > 0 ? stdDev(spreads) / meanSpread : 999;

      if (totalVol < minVol || volCV > maxVolCV || spreadCV > maxSpreadCV || volumes.length < 6 || spreads.length < 6) continue;

      const cur = latestData[itemId];
      const instabuy = cur && cur.high != null ? cur.high : null;
      const instasell = cur && cur.low != null ? cur.low : null;
      if (instabuy == null || instasell == null) continue;

      const highTime = cur && cur.highTime != null ? cur.highTime : null;
      const lowTime = cur && cur.lowTime != null ? cur.lowTime : null;
      const h1 = recent1h[itemId];
      const instabuy1h = h1 && h1.avgHighPrice != null ? h1.avgHighPrice : null;
      const instasell1h = h1 && h1.avgLowPrice != null ? h1.avgLowPrice : null;

      const margin = instabuy - instasell;
      opportunities.push({
        itemId,
        name: idToName[itemId] || "—",
        instabuy,
        instasell,
        highTime,
        lowTime,
        instabuy1h,
        instasell1h,
        margin,
        volCV,
        spreadCV
      });
    }

    opportunities.sort((a, b) => b.margin - a.margin);

    tbody.innerHTML = opportunities.length === 0
      ? "<tr><td colspan=\"8\" style=\"padding:14px 16px;color:#6b7280;\">No items match (try lowering min volume or raising max CV).</td></tr>"
      : opportunities.slice(0, 40).map(x => {
          const buyAge = timeAgo(x.highTime);
          const sellAge = timeAgo(x.lowTime);
          const buyStale = buyAge !== "just now" && buyAge !== "—" && buyAge.indexOf("s") === -1;
          const sellStale = sellAge !== "just now" && sellAge !== "—" && sellAge.indexOf("s") === -1;
          const buyAgeStyle = buyStale ? "font-size:11px;color:#6b7280;" : "font-size:11px;color:#6b7280;";
          const sellAgeStyle = sellStale ? "font-size:11px;color:#6b7280;" : "font-size:11px;color:#6b7280;";
          return `
          <tr style="border-bottom:1px solid #eee;">
            <td style="padding:14px 16px;">${(x.name || "—").replace(/</g, "&lt;")}</td>
            <td style="padding:14px 16px;text-align:right;"><span>${x.instabuy.toLocaleString()}</span><br><span style="${buyAgeStyle}">${buyAge}</span></td>
            <td style="padding:14px 16px;text-align:right;"><span>${x.instasell.toLocaleString()}</span><br><span style="${sellAgeStyle}">${sellAge}</span></td>
            <td style="padding:14px 16px;text-align:right;">${x.instabuy1h != null ? x.instabuy1h.toLocaleString() : "—"}</td>
            <td style="padding:14px 16px;text-align:right;">${x.instasell1h != null ? x.instasell1h.toLocaleString() : "—"}</td>
            <td style="padding:14px 16px;text-align:right;">${x.margin.toLocaleString()}</td>
            <td style="padding:14px 16px;text-align:right;">${(x.volCV * 100).toFixed(1)}%</td>
            <td style="padding:14px 16px;text-align:right;">${(x.spreadCV * 100).toFixed(1)}%</td>
          </tr>`;
        }).join("");

    updateLastUpdatedStamp();
  } catch (e) {
    tbody.innerHTML = "<tr><td colspan=\"8\" style=\"padding:14px 16px;color:#dc2626;\">Error: " + (e && e.message ? e.message : "network") + "</td></tr>";
  }
}

/* ITEM NAME AUTOCOMPLETE */

(function () {
  const nameInput = document.getElementById("log_item_name");
  const suggestionsEl = document.getElementById("log_item_suggestions");
  if (!nameInput || !suggestionsEl) return;
  let hideTimer = null;
  nameInput.addEventListener("input", function () {
    clearTimeout(hideTimer);
    showItemSuggestions(this.value);
  });
  nameInput.addEventListener("blur", function () {
    hideTimer = setTimeout(function () { suggestionsEl.style.display = "none"; }, 150);
  });
  nameInput.addEventListener("focus", function () {
    if (this.value.trim().length >= 2) showItemSuggestions(this.value);
  });
})();

/* RUN */

loadDashboard();

setInterval(loadDashboard, 60000);


</script>


</body>
</html>
