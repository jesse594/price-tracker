<!DOCTYPE html>
<html>
<head>
  <title>OSRS Price Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-wrap {
      width: 100%;
      max-width: 1000px;
      height: 500px;
    }
    .chart-wrap canvas {
      display: block;
    }
  </style>
</head>
<body>

<h2>OSRS Price Tracker</h2>

<div class="chart-wrap">
  <canvas id="chart"></canvas>
</div>

<script>

const SUPABASE_URL = "https://goabrqjuguybmvjlqylq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvYWJycWp1Z3V5Ym12amxxeWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjMxOTgsImV4cCI6MjA4NjgzOTE5OH0.INEv8kOskPZO6fU6827a9XZkkl8Smzqht5_KVDzQ_Ro";

function formatPrice(value) {
  if (value >= 1_000_000_000) {
    return (value / 1_000_000_000).toFixed(2) + "B";
  }
  if (value >= 1_000_000) {
    return (value / 1_000_000).toFixed(2) + "M";
  }
  if (value >= 1_000) {
    return (value / 1_000).toFixed(2) + "K";
  }
  return value;
}

async function loadData() {

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/prices?item_id=eq.20997&order=timestamp.asc`,
    {
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`
      }
    }
  );

  const data = await res.json();

  const labels = data.map(d =>
    new Date(d.timestamp * 1000).toLocaleTimeString()
  );

  const prices = data.map(d => d.mid_price);

  new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Twisted Bow Price",
        data: prices,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      elements: {
        point: {
          radius: 0,
          hitRadius: 6,
          hoverRadius: 4
        }
      },
      scales: {
        x: {
          ticks: {
            autoSkip: false,
            callback: function (value, index) {
              // Show a label roughly every 3 hours (data is every 5 minutes -> 36 points)
              const STEP = 36;
              return index % STEP === 0 ? labels[index] : "";
            }
          }
        },
        y: {
          ticks: {
            callback: (value) => formatPrice(value)
          }
        }
      }
    }
  });

}

loadData();

</script>

</body>
</html>
